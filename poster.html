<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>圖片合成範例</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; display: flex; flex-direction: row; flex-wrap: wrap; min-height: 100vh; background: #222; color: #fff; font-family: sans-serif; }
    .controls { width: 100%; max-width: 400px; padding: 20px; background: #333; overflow-y: auto; flex-shrink: 0; }
    .controls label { display: block; margin-top: 10px; }
    .controls input[type="text"], .controls input[type="number"], .controls input[type="file"] { width: 100%; padding: 4px; margin-top: 4px; }
    .controls button { margin-top: 15px; width: 100%; padding: 10px; font-size: 16px; background: #555; color: #fff; border: none; cursor: pointer; }
    canvas { flex: 1; width: 100%; max-width: 800px; background: #fff; border: 1px solid #000; margin: auto; display: block; }
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@900&display=swap');

    @media (min-width: 768px) {
      body { flex-direction: row; }
      .controls { width: 300px; }
      canvas { height: auto; }
    }
  </style>
</head>
<body>
  <div class="controls">
    <label for="photoInput">上傳照片</label>
    <input type="file" id="photoInput" accept="image/*" />

    <label for="text1Input">Coser名稱</label>
    <input type="text" id="text1Input" value="Coser名稱" />
    <label for="size1Input">字體大小</label>
    <input type="number" id="size1Input" value="64" />

    <label for="text2Input">攤位編號</label>
    <input type="text" id="text2Input" value="攤位編號 A01" />
    <label for="size2Input">字體大小</label>
    <input type="number" id="size2Input" value="56" />

    <button id="downloadBtn">下載圖片</button>
  </div>

  <canvas id="c" width="800" height="1200"></canvas>
  <script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');

    const photoInput = document.getElementById('photoInput');
    const text1Input = document.getElementById('text1Input');
    const text2Input = document.getElementById('text2Input');
    const size1Input = document.getElementById('size1Input');
    const size2Input = document.getElementById('size2Input');
    const downloadBtn = document.getElementById('downloadBtn');

    let text1 = { value: text1Input.value, x: 60, y: 1000, size: parseInt(size1Input.value) };
    let text2 = { value: text2Input.value, x: 60, y: 1080, size: parseInt(size2Input.value) };
    let draggingText = null;

    let portrait = new Image();
    portrait.src = 'https://i.imgur.com/8Km9tLL.jpg';

    let background = new Image();
    background.src = 'https://misa72600.github.io/poster-generator/images/123.png';

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (background.complete && background.naturalWidth > 0) ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
      if (portrait && portrait.complete && portrait.naturalWidth > 0) ctx.drawImage(portrait, 200, 300, 400, 600);

      [text1, text2].forEach(text => {
        ctx.font = `${text.size}px 'Noto Sans TC', sans-serif`;
        ctx.lineWidth = 8;
        ctx.strokeStyle = '#000';
        ctx.fillStyle = '#fff';
        ctx.strokeText(text.value, text.x, text.y);
        ctx.fillText(text.value, text.x, text.y);
      });
    }

    function updateText() {
      text1.value = text1Input.value;
      text2.value = text2Input.value;
      text1.size = parseInt(size1Input.value);
      text2.size = parseInt(size2Input.value);
      draw();
    }

    function init() {
      background.onload = () => {
        portrait.onload = () => {
          draw();

          canvas.addEventListener('mousedown', e => {
            const mx = e.offsetX, my = e.offsetY;
            [text1, text2].forEach(text => {
              ctx.font = `${text.size}px 'Noto Sans TC', sans-serif`;
              const width = ctx.measureText(text.value).width;
              const height = text.size;
              if (mx >= text.x && mx <= text.x + width && my <= text.y && my >= text.y - height) {
                draggingText = text;
              }
            });
          });

          canvas.addEventListener('mousemove', e => {
            if (draggingText) {
              draggingText.x = e.offsetX;
              draggingText.y = e.offsetY;
              draw();
            }
          });

          canvas.addEventListener('mouseup', () => {
            draggingText = null;
          });

          text1Input.addEventListener('input', updateText);
          text2Input.addEventListener('input', updateText);
          size1Input.addEventListener('input', updateText);
          size2Input.addEventListener('input', updateText);

          photoInput.addEventListener('change', e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
              portrait = new Image();
              portrait.onload = draw;
              portrait.src = event.target.result;
            };
            reader.readAsDataURL(file);
          });

          downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'poster.png';
            link.href = canvas.toDataURL();
            link.click();
          });
        };
      };

      background.onerror = () => alert("背景圖片載入失敗，請確認圖片網址是否正確。");
    }

    window.onload = init;
  </script>
</body>
</html>
